<script>
  var map;

  function initialize(){

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
      var mapcanvas = document.createElement('div');
      mapcanvas.id = 'mapcontainer';

      document.querySelector('article').appendChild(mapcanvas);

      var coords = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      
      var options = {
        zoom: 8,
        mapTypeControl: false,
        center: coords,
        navigationControlOptions: {
          style: google.maps.NavigationControlStyle.SMALL
        },
        mapTypeId: google.maps.MapTypeId.ROADMAP
      };

      map = new google.maps.Map(document.getElementById("mapcontainer"), options);
      
      var marker = new google.maps.Marker({
          position: coords,
          animation: google.maps.Animation.DROP,
          map: map,
          title: "<%= @user.name %>, <%= @user.updated_at %>"
      });
      // stores geolocation of user
      $(function(){
        var center = map.getCenter();
        // user_id will make user id dynamic to current_user
        var user_id = <%= @user.id.to_json %>
        // posts lat and lng to server
          $.ajax({
            url: "/users/current_location/" + user_id,
            data: { latitude: center.lat(), longitude: center.lng() },
            type: "POST",
            dataType: "json",
            success: function(data) {
              console.log(data);
            },
            failure: function() {
              alert("Unsuccessful");
            }
          });

        // finds user's friend's last location
        var friendLocation = new google.maps.LatLng(<%= @friend.latitude %>,<%= @friend.longitude %>);

        var directionsService = new google.maps.DirectionsService();
        var directionsRequest = {
            origin: center,
            destination: "Santa Ana, CA",
            travelMode: google.maps.DirectionsTravelMode.DRIVING,
            unitSystem: google.maps.UnitSystem.METRIC
        };

        directionsService.route(
          directionsRequest,
          function(response, status)
            {
              if (status == google.maps.DirectionsStatus.OK)
              {
                new google.maps.DirectionsRenderer({
                  map: map,
                  directions: response
                });
              }
            
            else
              $("#error").append("Unable to retrieve your route<br />");
          });
        });
      });
    } 
    else {
    // Browser doesn't support Geolocation
      handleNoGeolocation(false);
    }
  }
  google.maps.event.addDomListener(window, "load", initialize);

</script>