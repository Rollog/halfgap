<% content_for :content do %>
  
  <section id="map-wrapper">
    <div id="map"></div>
    <a href='#' id='geolocate'>Find</a>


    <article></article>
    <script>

    $(function(){ 

      var map = L.mapbox.map('map', 'randyrlee.gj1k9e25');   

      function initialize(){

        if (!navigator.geolocation) {
            geolocate.innerHTML = 'geolocation is not available';
        } else {
            geolocate.onclick = function (e) {
                e.preventDefault();
                e.stopPropagation();
                map.locate();
            };
        };

        /// Once we've got a position, zoom and center the map
        // on it, and add a single marker.
        map.on('locationfound', function(e) {
            map.fitBounds(e.bounds);

            var location = map.markerLayer.setGeoJSON({
                type: "Feature",
                geometry: {
                    type: "Point",
                    coordinates: [e.latlng.lng, e.latlng.lat]
                },
                properties: {
                    'marker-color': '#000',
                    'marker-symbol': 'star-stroked'
                }
            });
            // debugger;
            console.log(location);

            var geolocation = location._geojson.geometry.coordinates;


            console.log(geolocation);

            // var center = map.getCenter();
            // user_id will make user id dynamic to current_user
            var user_id = <%= @user.id.to_json %>
            // posts lat and lng to server
            $.ajax({
              url: "/users/current_location/" + user_id,
              data: { latitude: geolocation[1], longitude: geolocation[0] },
              type: "POST",
              dataType: "json",
              success: function(data) {
                console.log(data);
              },
              failure: function() {
                alert("Unsuccessful");
              }
            });
            // And hide the geolocation button
            geolocate.parentNode.removeChild(geolocate);
        });

        // If the user chooses not to allow their location
        // to be shared, display an error message.
        map.on('locationerror', function() {
            geolocate.innerHTML = 'position could not be found';
        });

        findFriends()        
        // debugger;
        
      }

    function findFriends() {

      var friendsCoords = [];
      var friendsName = [];

      <% @user.friends.each do |f| %>
        friendsCoords.push(L.latLng(<%= f.latitude %>,<%= f.longitude %>));
        // friendsName.push(<%= f.name.capitalize.to_s %>);
      <% end %>

      console.log(friendsCoords);
      console.log(friendsName);

      var i;

      for (i=0; i < friendsCoords.length; i++) {
        var markerLayer = L.marker([friendsCoords[i]['lat'], friendsCoords[i]['lng']],
          {
            title: 'Yo Friend'
          }).addTo(map);

        console.log(markerLayer);
      
        markerLayer.eachLayer(function(layer) {
          // here you call `bindPopup` with a string of HTML you create - the feature
          // properties declared above are available under `layer.feature.properties`

          var content = '<h1>size: ' + layer.feature.properties.size + '<\/h1>' +
              '<h2>population: ' + layer.feature.properties.population + '<\/h2>';
          layer.bindPopup(content);
        });
      };
    } 
     
     google.maps.event.addDomListener(window, "load", initialize);

    });

    </script>
    <div id="bottom_nav">
      <%= link_to "", meet_requests_path, class: "glyphicon glyphicon-th" %>
    </div>  
  </section>

<% end %>
        