<% content_for :content do %>
  <section id="map-wrapper">
  <!-- Click the allow button to let the halfgap find your location. -->
  <article></article>
    <script>
      var map;

      function initialize(){

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
          var mapcanvas = document.createElement('div');
          mapcanvas.id = 'mapcontainer';
          // mapcanvas.style.height = '480px';
          // mapcanvas.style.width = '320px';

          document.querySelector('article').appendChild(mapcanvas);

          var coords = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
          
          var options = {
            zoom: 10,
            mapTypeControl: false,
            center: coords,
            navigationControlOptions: {
              style: google.maps.NavigationControlStyle.SMALL
            },
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };

          map = new google.maps.Map(document.getElementById("mapcontainer"), options);
          
          var marker = new google.maps.Marker({
              position: coords,
              animation: google.maps.Animation.DROP,
              map: map,
              title: "<%= @user.name %>, <%= @user.updated_at %>"
          });
          // geolocates user
          $(function(){
            var center = map.getCenter();
            // user_id will make user id dynamic to current_user
            var user_id = <%= @user.id.to_json %>
            // posts lat and lng to server
              $.ajax({
                url: "/users/current_location/" + user_id,
                data: { latitude: center.lat(), longitude: center.lng() },
                type: "POST",
                dataType: "json",
                success: function(data) {
                  console.log(data);
                },
                failure: function() {
                  alert("Unsuccessful");
                }
              });

              var friendsCoords = [];

              <% @user.friends.each do |f| %>
                friendsCoords.push(new google.maps.LatLng(<%= f.latitude %>,<%= f.longitude %>));
              <% end %>

              var i, newMarker;

              for (i=0; i < friendsCoords.length; i++) {
                newMarker = new google.maps.Marker({
                  position: (friendsCoords[i]),
                  map: map,
                  draggable: true
                });

                newMarker.setVisible(true);
              };

          });
        });
      } 
      else {
      // Browser doesn't support Geolocation
          handleNoGeolocation(false);
        }
      }
     google.maps.event.addDomListener(window, "load", initialize);

    </script>
    <%= link_to "Sign Out", logout_path, method: "delete" %>
  </section>
<% end %>
        